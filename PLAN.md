# Playwrightベース全面移行計画（e-Gov法令検索スクレイピング）

## 概要

`e-gov-jobun-to-obsidian` を Rust + API 依存構成から、Node.js + Playwright のスクレイピング主軸へ移行する。
API利用は、法令名からlaw_idの取得など一部の利用にとどまることになる。

取得対象は「本文 + 参照リンク情報」を `https://laws.e-gov.go.jp/law/{law_id}` から直接抽出し、Obsidian向けMarkdownを生成する。  
失敗時は規定回数リトライする。

## 目的

APIから得られる法令文にはリンク情報が含まれておらず、自力でリンクを作る必要があり難易度が高い。
他方、web `https://laws.e-gov.go.jp/law/{law_id}` ではハイパーリンクされているのでその情報を利用できる。

## アーキテクチャ変更

- 旧:

1. Rust CLI（`reqwest`）で `/api/2/laws` `/api/2/law_data` を呼び出し。
2. JSON構造を解析してMarkdown化。

- 新:

1. Node CLI（TypeScript）を新規作成。
2. Playwright で `laws.e-gov.go.jp` を操作。
3. DOMから法令本文・見出しID・参照リンクを抽出。
4. Markdownレンダラで `laws/*.md` を出力。
5. 未解決参照ログ・辞書キャッシュは `data/` に保存。

## 公開インターフェース（CLI）仕様

- 新CLIコマンド（案）:

1. `node dist/cli.js "<法令名>"
   - こちらの場合は、APIでlaw_idを取得してからスクレイピングする
   - 一意に定まらない場合は法令名とlaw_idのペアで情報出力して終了
     - law_id を指定して再実行することで一意に定まることにになる
2. `node dist/cli.js --law-id <law_id> ...`

- 実行方式:

1. 標準は Docker（Playwright公式イメージベース）。
2. `docker compose run --rm app "<法令名>"` を正式手順とする。
3. ローカル直実行は任意サポート（計画時点では必須にしない）。

## データ仕様

- `laws/<safe_title>.md`

1. 先頭にメタ情報(フロントマター): 法令名、law_id、取得時刻、取得元URL
2. スクレイピングして得られた法令本文について、htmlに準じてアンカーを付与する
3. 同じく、htmlのハイパーリンクに準じて Obsidianリンク化

## 取得・解析フロー（決定版）

1. 入力（法令名 or law_id）を受理。
2. 法令名の場合:

- APIで候補解決。
- 一意でなければAPIで得られた候補の一覧を出力して終了

3. Playwrightで法令ページへ遷移。
4. 本文コンテナが表示されるまで待機（明示セレクタ + タイムアウト）。
5. DOMからコンテンツを抽出
6. Markdown生成時にリンク正規化
7. ファイル出力:

- `laws/<safe_title>.md` は root law単位で再生成（同名は上書き）。

## エラー処理・再試行

- フォールバック方針: API呼び直しはしない。
- 再試行:

1. ネットワーク失敗/DOM未表示時のみ最大 `--retry` 回。
2. 各回で待機時間を指数バックオフ。
3. 全失敗時は非0終了コード + エラーログ出力。
4. 部分成功（本文生成済みで一部参照未解決）は成功終了し、未解決をログへ。

## ファイル名長対策

- 既存問題（`File name too long`）に対処:

1. `safe_title` は正規化 + 文字数上限（例: 80）。
2. 超過時は `title_trunc + "_" + law_id` を採用。
3. 同名衝突時は law_id 優先で一意化。

## テスト計画

- 単体テスト:

1. DOM断片→条文構造抽出のパーサテスト。
2. 参照リンク正規化（内部/外部/未解決）。
3. ファイル名正規化と長さ制限。

- フィクスチャテスト:

1. 実ページHTMLダンプ（ローカル保存）からMarkdown生成。
2. 期待リンク数・未解決件数・主要見出し存在をアサート。

- E2E（Docker）:

1. <特許法のlaw_id> を入力して `laws/*.md` 生成確認。
2. 同一入力再実行で安定出力（差分最小）確認。

## 移行手順

1. Node/TSプロジェクト雛形追加（`package.json`, `tsconfig`, `src/`）。
2. Dockerfile + compose定義をPlaywright向けに追加。
3. 取得・抽出・変換・出力モジュールを段階実装。
4. 既存Rust CLIは削除

## 前提・仮定（明示）

1. e-GovページはSPAで、静的HTMLに本文・リンクが直接埋まらないためJS実行が必要。
2. 利用規約・アクセス制限は運用時に遵守し、過度な並列取得は行わない（デフォルト直列）。
3. robots確認は現時点で明示取得できなかったため、保守的レート制御（1法令ずつ、待機あり）を既定とする。
4. 既定言語・コメント方針は `AGENTS.md` に従い日本語で記述する。
